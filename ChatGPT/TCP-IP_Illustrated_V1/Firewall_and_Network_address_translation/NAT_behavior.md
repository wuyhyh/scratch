在 **NAT（网络地址转换，Network Address Translation）** 中，端口和地址的行为决定了数据包如何在内外部网络之间传递。NAT 的实现方式可以分为几种不同的类型，这些类型会影响 NAT 如何处理 IP 地址和端口，以及它们在网络中的表现。以下是 NAT 中端口和地址的主要行为模式：

### 1. **基本 NAT（静态 NAT）**

**基本 NAT** 也称为 **静态 NAT**，在这种类型中，内部网络的私有 IP 地址被永久映射到外部网络的一个公共 IP 地址。静态 NAT 不涉及端口的转换，仅是地址之间的直接映射。

- **IP 地址转换**：内部的每个私有 IP 地址都对应一个公共 IP 地址。
- **端口不变**：数据包中的源端口号保持不变，只有 IP 地址被替换。
- **行为**：
    - **地址固定映射**：每个内部设备始终通过相同的公共 IP 地址进行外部通信。
    - **适用场景**：适用于内部某些设备需要固定公共 IP 地址进行外部通信的场景，如提供外部服务的服务器。

#### 示例：
- 内部设备 `192.168.1.100` 被映射为外部的 `198.51.100.1`，所有流量通过这个公共地址传输。
- 端口号不发生变化，内外部的端口号相同。

### 2. **动态 NAT**

**动态 NAT** 是一种根据需要为内部设备分配公共 IP 地址的 NAT 类型。动态 NAT 使用一个公共 IP 地址池，当内网设备发起外部连接时，从池中随机选择一个可用的公共 IP 地址进行映射。

- **IP 地址转换**：动态 NAT 从一组公共 IP 地址中选择一个可用的地址进行映射。
- **端口不变**：与静态 NAT 相同，端口号不进行转换。
- **行为**：
    - **地址动态映射**：每次内部设备发起连接时，可能会分配不同的公共 IP 地址。
    - **适用场景**：适用于内部设备不需要固定公共 IP 地址的场景，但公共地址数量比内部设备少。

#### 示例：
- 内部设备 `192.168.1.100` 可能被映射为 `198.51.100.2`，下一次连接时可能被映射为 `198.51.100.3`。

### 3. **NAPT（网络地址和端口转换）**

**NAPT**（也叫 **PAT**，端口地址转换）是最常用的 NAT 类型，它允许多个内部设备通过一个或多个公共 IP 地址进行外部通信。NAPT 使用不同的端口号来区分多个设备的连接。

- **IP 地址和端口转换**：NAPT 不仅转换 IP 地址，还会转换源端口号，以便多个内部设备共享同一个公共 IP 地址。
- **端口复用**：多个内部设备可以共享一个公共 IP 地址，但使用不同的端口号来标识每个连接。
- **行为**：
    - **端口重写**：内部设备的源端口号被替换为一个全局唯一的外部端口号，这样可以通过公共 IP 地址的不同端口区分不同的内部设备。
    - **地址和端口动态映射**：根据流量动态映射地址和端口，并在 NAT 表中维护映射关系。
    - **适用场景**：适用于家庭网络、企业局域网等多个设备共享一个或少量公共 IP 地址的场景。

#### 示例：
- 内部设备 `192.168.1.100:12345` 可能映射为 `198.51.100.1:50000`，而另一个设备 `192.168.1.101:54321` 可能映射为 `198.51.100.1:50001`。

### 4. **端口触发（Port Triggering）**

端口触发是一种动态分配端口的 NAT 行为，当内部设备发起特定类型的连接时，会动态开放一个或多个端口，用于允许外部设备通过该端口访问内部设备。

- **端口动态分配**：当内部设备使用特定端口发起外部连接时，路由器会临时开放对应的外部端口，允许外部设备连接。
- **行为**：
    - **端口开放**：内部设备发起连接后，特定的端口对外部设备开放，用于双向通信。
    - **适用场景**：适用于需要外部设备在特定情况下访问内部网络的场景，如网络游戏、VoIP。

#### 示例：
- 内部设备 `192.168.1.100:40000` 发起连接时，NAT 会打开外部的 `198.51.100.1:50000` 端口供外部设备连接。

### 5. **端口映射（Port Forwarding）**

端口映射（也称为端口转发）是 NAT 的一种行为，用于将外部网络的特定端口流量转发到内部网络的某个设备或服务上。它允许外部设备通过访问公共 IP 地址上的特定端口，与内网中的特定设备进行通信。

- **端口和地址绑定**：公共 IP 地址的一个或多个端口被永久映射到特定的内部 IP 地址和端口。
- **行为**：
    - **静态端口映射**：端口映射通常是静态的，管理员手动配置某个外部端口与内部设备的端口关联。
    - **适用场景**：适用于需要外部设备访问内网中特定服务的场景，如 Web 服务器、FTP 服务器等。

#### 示例：
- 通过端口映射，外部访问 `198.51.100.1:8080` 可以被转发到内部设备 `192.168.1.100:80`。

### 6. **NAT 类型的端口和地址行为分类**

根据端口和地址的转换行为，NAT 还可以分为不同的类型，影响数据包的处理方式：

#### **全锥形 NAT（Full Cone NAT）**
- **行为**：所有来自内部网络的请求只要映射了公共 IP 地址和端口，任何外部设备都可以通过该公共 IP 地址和端口与内部设备进行通信。
- **地址和端口保持不变**，允许所有外部设备访问。

#### **受限锥形 NAT（Restricted Cone NAT）**
- **行为**：只有内部设备发起通信后，外部设备才能通过公共 IP 地址和端口与内部设备进行通信，且限制为目标 IP 地址匹配的外部设备。
- **地址绑定受限**：只有最初内网通信的目标外部地址可以反向通信。

#### **端口受限锥形 NAT（Port Restricted Cone NAT）**
- **行为**：与受限锥形 NAT 类似，但进一步限制为外部设备的端口号也必须与最初的请求匹配。
- **端口绑定受限**：内网设备只接受来自与其初始通信端口相同的外部端口的返回流量。

#### **对称 NAT（Symmetric NAT）**
- **行为**：每个不同的外部请求（即不同的目的 IP 和端口）都会映射到不同的公共 IP 地址和端口号，只有相同的目的 IP 和端口才能与内部设备进行通信。
- **地址和端口都动态映射**：适用于安全性更高的场景，但可能会阻碍某些 P2P 应用程序的连接。

### 总结

在 **NAT** 中，端口和地址的行为根据不同的 NAT 类型和机制表现出不同的特点：

1. **静态 NAT**：只转换 IP 地址，端口保持不变，适合需要固定 IP 地址的场景。
2. **动态 NAT**：根据需求动态分配 IP 地址，适合 IP 资源有限的环境。
3. **NAPT**：同时转换 IP 地址和端口，适合多个设备共享一个公共 IP 地址的环境，是最常见的 NAT 类型。
4. **端口映射和触发**：允许外部设备通过特定端口访问内部服务，通常用于特定的应用场景如服务器或游戏。
5. **不同的 NAT 类型（全锥形、受限锥形、对称等）**：决定了外部设备如何与内部设备进行通信，影响安全性和应用兼容性。

这些行为不仅影响网络的连接方式，也直接影响了外部设备访问内部网络服务的能力。
