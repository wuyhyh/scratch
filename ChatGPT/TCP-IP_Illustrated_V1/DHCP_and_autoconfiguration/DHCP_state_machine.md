DHCP 状态机定义了 DHCP 客户端与服务器之间的交互过程，描述了从客户端启动到租用 IP 地址的整个生命周期。通过状态机，可以很好地理解 DHCP 协议的工作机制，包括如何获取、续租和释放 IP 地址。DHCP 状态机由多个状态组成，客户端在不同的状态之间切换来完成地址分配、续租和释放。

### DHCP 状态机的主要步骤与状态

1. **初始化状态（INIT）**
    - 当 DHCP 客户端启动时，它进入 **初始化（INIT）** 状态。
    - 客户端没有 IP 地址，且不知道 DHCP 服务器的地址，所以它会通过广播方式发送一个 **DHCP 发现（DHCPDISCOVER）** 消息，告知网络中的 DHCP 服务器它需要一个 IP 地址。
    - 这个消息是广播的，目标 MAC 地址是全网广播地址（`FF:FF:FF:FF:FF:FF`），并且目标 IP 地址是 `255.255.255.255`，因为客户端在这一阶段没有自己的 IP 地址。

2. **等待提供状态（WAITING FOR OFFER）**
    - 服务器接收到 DHCP 发现消息后，会返回 **DHCP 提供（DHCPOFFER）** 消息，向客户端提供一个可用的 IP 地址、租期和其他网络配置信息（如子网掩码、网关、DNS 等）。
    - 客户端在这个状态下等待 DHCP 提供消息。

3. **选择状态（SELECTING）**
    - 如果网络中有多个 DHCP 服务器，它们都会发送 **DHCPOFFER** 消息。客户端可以从这些提供的地址中选择一个最合适的。
    - 一旦客户端选择了一个 DHCP 提供，它将进入 **选择（SELECTING）** 状态，并向对应的 DHCP 服务器发送一个 **DHCP 请求（DHCPREQUEST）** 消息，确认它要使用该服务器提供的 IP 地址。

4. **请求状态（REQUESTING）**
    - 客户端发出 **DHCP 请求** 消息后，进入 **请求（REQUESTING）** 状态，等待服务器的确认。
    - DHCP 服务器接收到客户端的请求后，将对请求进行处理，检查该 IP 地址是否仍然可用。

5. **绑定状态（BOUND）**
    - 当 DHCP 服务器确认请求的 IP 地址可用时，它会发送 **DHCP 确认（DHCPACK）** 消息给客户端，正式分配 IP 地址，并告知租期、默认网关、DNS 服务器等信息。
    - 客户端收到 **DHCPACK** 消息后进入 **绑定（BOUND）** 状态，这意味着客户端已成功获得 IP 地址并可以使用该地址进行网络通信。
    - 此时，客户端会开始使用租期中的时间来跟踪 IP 地址的有效性。

6. **重新绑定状态（RENEWING）**
    - 在租期到期前的 50% 阶段，客户端会进入 **续租（RENEWING）** 状态，并向分配它 IP 地址的 DHCP 服务器发送 **DHCP 请求（DHCPREQUEST）** 消息，尝试续租 IP 地址。
    - 如果 DHCP 服务器回复 **DHCP 确认（DHCPACK）** 消息，客户端将续租该 IP 地址，并继续使用当前的 IP 地址。
    - 如果 DHCP 服务器没有响应，客户端将继续在当前网络上尝试与该服务器通信。

7. **重绑定状态（REBINDING）**
    - 如果客户端在 50% 的续租阶段没有得到服务器响应，且租期达到 87.5% 时，它会进入 **重绑定（REBINDING）** 状态，向网络中的所有 DHCP 服务器发送广播的 DHCP 请求消息，尝试与任何可用的 DHCP 服务器续租。
    - 此时，客户端可以从其他 DHCP 服务器获取确认消息，延长租期。
    - 如果某个服务器响应并发送 **DHCPACK** 消息，客户端将更新租期并进入 **绑定状态**。

8. **租期到期状态（EXPIRED）**
    - 如果租期到期，且客户端没有收到任何 DHCP 服务器的确认（即没有续租成功），客户端的 IP 地址将失效，它会进入 **租期到期（EXPIRED）** 状态。
    - 在该状态下，客户端必须停止使用当前的 IP 地址，并重新进入 **初始化（INIT）** 状态，开始新的 DHCP 发现过程以获得新的 IP 地址。

9. **释放状态（RELEASE）**
    - 如果客户端主动释放 IP 地址，它会发送一个 **DHCP 释放（DHCPRELEASE）** 消息给 DHCP 服务器，告知服务器该 IP 地址不再使用。
    - 客户端进入 **释放（RELEASE）** 状态，IP 地址被释放，DHCP 服务器可以将该地址分配给其他客户端。

### DHCP 状态机的整体流程

以下是 DHCP 状态机的主要步骤和状态之间的转换：

1. **INIT（初始化）** → DHCP 客户端通过广播方式发送 DHCP 发现消息（DHCPDISCOVER）。
2. **WAITING FOR OFFER（等待提供）** → 客户端等待 DHCP 服务器发送提供消息（DHCPOFFER）。
3. **SELECTING（选择）** → 客户端选择 DHCP 服务器，并发送 DHCP 请求消息（DHCPREQUEST）。
4. **REQUESTING（请求）** → 客户端等待 DHCP 服务器的确认消息。
5. **BOUND（绑定）** → 客户端接收到 DHCP 服务器的确认消息，成功获得 IP 地址。
6. **RENEWING（续租）** → 租期过半时，客户端尝试与 DHCP 服务器续租 IP 地址。
7. **REBINDING（重绑定）** → 如果续租失败，客户端广播请求续租其他服务器的 IP 地址。
8. **EXPIRED（租期到期）** → 如果续租失败且租期过期，客户端释放 IP 地址，重新进入初始化状态。
9. **RELEASE（释放）** → 客户端主动释放 IP 地址，返回初始化状态。

### DHCP 状态机图示

```
+-----------+        +------------+         +------------+
| INIT      | -----> | SELECTING  | ------> | REQUESTING |
+-----------+        +------------+         +------------+
                                      |
                                      v
                                +------------+
                                |  BOUND     |
                                +------------+
                                      |
                                      v
                                +------------+
                                | RENEWING   |
                                +------------+
                                      |
                                      v
                                +------------+
                                | REBINDING  |
                                +------------+
                                      |
                                      v
                                +------------+
                                |  EXPIRED   |
                                +------------+

```

### 总结

DHCP 状态机通过多个状态来管理客户端与 DHCP 服务器之间的交互，确保客户端能够动态地获取 IP 地址并管理租期。该状态机从客户端请求 IP 地址开始，经过地址分配、租期管理、续租及到期等过程，确保了网络中 IP 地址的高效利用和动态分配。
