## PCI

PCI接口的探测过程主要是通过系统的BIOS或者操作系统在启动时进行的。以下是PCI接口实现探测的一般过程：

### 1. **总线扫描**
在系统启动时，BIOS或操作系统会扫描PCI总线。PCI总线通常是分层次的，根总线（Bus 0）可能有多个桥接器（Bridge），这些桥接器可能连接到其他总线。系统会从根总线开始逐层扫描所有总线，直到找到所有连接的PCI设备。

### 2. **设备枚举**
每个PCI设备都有一个固定的配置空间，系统在扫描每个总线时会尝试读取这些设备的配置空间来识别设备。系统会使用一个特殊的地址访问机制来读取配置空间的前64字节，这些字节包含了设备的基本信息，如：
- **设备ID（Device ID）**：标识特定设备的唯一编号。
- **供应商ID（Vendor ID）**：标识设备制造商的编号。
- **类代码（Class Code）**：设备的类别，如网络控制器、显卡等。
- **子系统ID和子系统供应商ID**：用于进一步识别特定设备型号。

### 3. **读取配置空间**
每个PCI设备都有256字节的配置空间（PCI 2.0及更高版本是4096字节），配置空间存储了设备的各种信息和状态寄存器。通过配置空间的读取，操作系统可以确定设备的功能以及它需要使用的资源（如内存地址、I/O地址、中断号等）。

### 4. **分配资源**
操作系统会根据配置空间中描述的资源需求，分配设备所需的I/O地址范围、内存地址范围、中断线等。然后，操作系统会将这些分配信息写回到设备的配置空间中，以便设备能够正确工作。

### 5. **驱动程序加载**
当操作系统检测到设备后，会根据设备的ID来查找合适的驱动程序。一旦找到相应的驱动程序，操作系统会加载驱动程序并初始化设备，使其开始正常工作。

### 6. **热插拔设备探测**
对于支持热插拔的系统（如PCI Express），操作系统还会不断监视总线，以检测新的设备插入或设备移除。

### 7. **错误处理**
如果探测过程中发生错误（例如无法识别设备，或资源分配冲突），操作系统会记录错误并尝试进行纠正。

这种探测机制允许操作系统动态地识别、配置和管理各种PCI设备，从而实现设备的即插即用。

## PCIe

PCIe（PCI Express）的设备探测过程与传统的PCI有很多相似之处，但由于PCIe是基于点对点串行连接的高性能总线，其探测机制在实现上有一些不同。以下是PCIe设备探测的过程：

### 1. **链路初始化**
在系统启动或复位时，主板上的PCIe控制器会首先初始化所有连接的PCIe链路。链路初始化过程包括链路训练和协商过程，用于确定链路的工作速率和带宽。例如，确定是使用x1、x4、x8还是x16链路宽度，以及链路的传输速率（如2.5 GT/s, 5 GT/s, 8 GT/s, 16 GT/s）。

### 2. **总线扫描**
PCIe的设备是通过层级结构（树状结构）连接的，根复杂（Root Complex）连接到一个或多个PCIe端口，每个端口可能连接到多个设备或桥接器（Bridge）。系统会从根复杂开始，逐级扫描每个PCIe设备和桥接器，直到找到所有连接的设备。

### 3. **设备枚举**
与传统PCI类似，PCIe设备也有自己的配置空间。系统在扫描过程中会尝试访问这些设备的配置空间，读取前64字节以获取设备的基本信息，包括设备ID、供应商ID、类代码等。

### 4. **读取扩展配置空间**
PCIe设备的配置空间与PCI类似，但它们可以支持更大的扩展配置空间（最大为4096字节），这使得设备可以提供更多的功能和状态信息。操作系统通过读取配置空间中的信息，了解设备的功能，并确定需要分配的系统资源（如内存地址、中断线等）。

### 5. **资源分配**
操作系统会根据设备的资源需求，分配内存地址范围、I/O地址范围以及中断线等。PCIe的配置空间中包含了Base Address Registers (BARs)等信息，用于描述设备的资源需求。操作系统将资源分配信息写入这些寄存器，使设备可以使用系统资源。

### 6. **驱动程序加载**
操作系统会根据设备ID和供应商ID匹配合适的驱动程序，并加载该驱动程序以初始化设备。这一步骤确保了设备能够被正确识别和使用。

### 7. **热插拔设备探测**
PCIe天然支持热插拔功能，特别是在服务器和高端工作站中广泛使用。当一个新的PCIe设备被插入时，PCIe总线会自动检测到链路的改变，并通知操作系统。操作系统会执行一个简化的探测过程，以识别和配置新的设备。

### 8. **错误处理**
在探测过程中，如果发生任何错误（如设备无法识别或资源分配失败），操作系统会记录错误并可能尝试纠正问题。对于PCIe设备，错误处理机制更加复杂，包括链路错误、数据传输错误等。

### 9. **高级功能支持**
PCIe协议支持比PCI更高级的功能，例如消息信号中断（MSI/MSI-X）、高级错误报告（AER）、电源管理等。这些功能使得PCIe设备能够提供更高的性能和更好的错误恢复能力。

总的来说，PCIe的探测机制在设计上更加先进，能够更有效地利用系统资源，同时提供更高的带宽和更低的延迟。操作系统通过扫描、枚举、配置和驱动加载等步骤，确保PCIe设备能够被正确识别和使用。