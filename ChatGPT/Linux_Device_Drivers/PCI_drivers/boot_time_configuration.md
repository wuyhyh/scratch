在系统启动时，PCI和PCIe设备的配置是一个关键的过程，它们的配置过程虽然相似，但由于PCIe是基于串行点对点连接的架构，配置细节有所不同。以下是两者在启动时的配置过程：

### **PCI的启动配置过程**

1. **硬件初始化**
    - 当系统上电或复位时，BIOS会开始执行初始化流程。BIOS首先对整个系统的硬件进行基本初始化，包括处理器、内存、和I/O控制器等。

2. **总线枚举和扫描**
    - BIOS会开始扫描PCI总线。PCI总线的扫描从总线号0开始，逐个枚举所有连接的设备和桥接器。
    - 每个PCI设备都有一个唯一的总线号、设备号和功能号组合。BIOS通过对这些组合进行扫描来识别所有的PCI设备。

3. **设备枚举和配置空间访问**
    - BIOS访问每个PCI设备的配置空间，通过读取设备ID和供应商ID来识别设备。
    - BIOS还会读取配置空间中的类代码、子系统ID和子系统供应商ID，以确定设备的类型和功能。

4. **资源分配**
    - BIOS为每个PCI设备分配I/O地址空间、内存地址空间和中断线（IRQ）。这些资源由设备的基地址寄存器（BARs）描述，BIOS会将分配好的资源写入这些寄存器中。
    - 在分配过程中，BIOS会确保不会出现资源冲突（如两个设备共享相同的I/O地址或内存地址）。

5. **设置设备使能**
    - 一旦资源分配完成，BIOS会设置设备的状态寄存器，启用I/O、内存空间访问和中断功能。
    - 最后，BIOS保存这些配置，并继续执行系统引导流程，最终将控制权移交给操作系统。

### **PCIe的启动配置过程**

1. **链路初始化**
    - PCIe设备在启动时会进行链路初始化。链路初始化包括链路训练和协商，用于确定链路的传输速率和宽度（如x1, x4, x8, x16）。
    - 链路初始化完成后，设备和根复杂（Root Complex）之间的链路建立并准备好进行数据传输。

2. **设备扫描和枚举**
    - 与传统PCI类似，BIOS或UEFI固件会从根复杂开始，逐级扫描PCIe链路上的设备。
    - 每个PCIe设备的配置空间由256字节（或4096字节）组成，BIOS会读取配置空间中的设备ID、供应商ID、类代码等信息，识别设备的类型和功能。

3. **资源分配**
    - BIOS为PCIe设备分配内存地址空间（PCIe不再使用I/O地址空间）、中断线（通常为MSI或MSI-X）。
    - PCIe设备的基地址寄存器（BARs）描述了设备需要的资源，BIOS会分配合适的物理内存地址，并将其写入BAR寄存器中。

4. **中继和桥接配置**
    - 如果系统中有PCIe到PCI桥接器（或者PCIe到PCIe桥接器），BIOS还会配置这些桥接器，确保下游设备能够正确访问和使用上游分配的资源。

5. **设备初始化**
    - 资源分配完成后，BIOS会通过设置状态寄存器来启用PCIe设备的内存空间和中断功能。
    - PCIe设备的高级功能，如电源管理、高级错误报告（AER）等，也会在此阶段通过配置空间进行设置。

6. **固件挂钩和扩展配置**
    - 一些高级系统中，UEFI固件可能还会配置PCIe设备的扩展功能，如SR-IOV（单根I/O虚拟化）、ACS（访问控制服务）等。
    - 这些功能通常用于虚拟化环境或需要高级I/O控制的系统。

7. **控制权移交**
    - 一旦所有PCIe设备的配置完成，BIOS或UEFI将控制权移交给操作系统，操作系统将进一步初始化设备，并加载相应的驱动程序。

### **总结**

- **PCI**设备的配置主要通过BIOS扫描设备的配置空间、分配I/O和内存地址空间以及中断资源来完成。配置过程较为简单，设备通常通过I/O地址和内存地址进行访问。
- **PCIe**设备的配置则更复杂，涉及链路初始化、设备扫描、资源分配（主要是内存映射I/O）、以及高级功能的设置。PCIe采用串行传输和点对点连接，支持更高的带宽和更多的高级功能。BIOS或UEFI在启动时会完成这些配置，然后操作系统接管设备的进一步初始化和驱动加载。