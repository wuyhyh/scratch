在PCI和PCIe中，配置寄存器的初始化是启动过程中的关键步骤。这些寄存器在系统启动时被BIOS或UEFI固件初始化，确保每个设备能够正确识别、分配资源并准备使用。以下是PCI和PCIe中配置寄存器初始化的详细步骤：

### **1. PCI中的配置寄存器初始化**

#### **配置空间**
PCI设备的配置空间由一系列寄存器组成，提供了设备的基本信息、状态以及资源需求。每个PCI设备的配置空间至少有256字节。

#### **初始化过程**
1. **硬件复位**:
    - 在系统启动或复位时，所有PCI设备都会进行硬件复位。此时，配置寄存器处于默认状态，一些寄存器可能被设置为全零或预设的初始值。

2. **总线扫描和设备识别**:
    - BIOS会从根总线开始扫描每个PCI总线上的设备。扫描过程中，BIOS会读取设备的配置空间中的固定寄存器，尤其是前64字节，其中包含设备ID、供应商ID、类代码等关键信息。
    - 这些信息用于识别设备类型、供应商和功能。

3. **资源需求分析**:
    - BIOS读取配置空间中的基地址寄存器（Base Address Registers, BARs），这些寄存器指示设备需要的I/O地址空间或内存地址空间的大小和类型。
    - BIOS通过写入全`1`到BAR寄存器，然后读取寄存器的值来确定设备需要的资源大小。

4. **资源分配**:
    - 根据每个设备的资源需求，BIOS会为设备分配合适的I/O地址空间或内存地址空间，并将这些分配的地址写入BAR寄存器中。
    - 中断线（IRQ）也在此阶段分配给设备，并写入配置空间中的中断寄存器。

5. **设备使能**:
    - BIOS通过配置空间中的命令寄存器（Command Register）启用设备的I/O和内存空间访问，以及中断功能。
    - 此外，状态寄存器（Status Register）也会在此阶段进行初始化，反映设备的当前状态。

### **2. PCIe中的配置寄存器初始化**

#### **配置空间**
PCIe设备的配置空间类似于PCI，通常也是4096字节的大小。PCIe设备的配置空间包含标准的PCI寄存器以及PCIe特有的扩展寄存器。

#### **初始化过程**
1. **链路初始化**:
    - 在系统启动时，PCIe设备首先进行链路初始化，链路训练过程确定链路的工作参数，如速率和宽度。
    - 在链路成功建立后，PCIe设备的配置寄存器进入可以访问的状态。

2. **总线扫描和设备识别**:
    - 与PCI类似，BIOS或UEFI固件会从根复杂（Root Complex）开始扫描PCIe设备，通过读取配置空间中的设备ID、供应商ID等寄存器来识别设备。
    - PCIe设备的前64字节配置空间仍然遵循PCI标准，用于基本的设备识别和初始化。

3. **资源需求分析**:
    - BIOS读取PCIe设备的BAR寄存器，确定设备需要的内存地址空间。
    - 与PCI不同，PCIe设备主要使用内存映射I/O（MMIO）来进行资源分配，不再使用传统的I/O地址空间。

4. **高级功能初始化**:
    - PCIe设备可能包含一些PCIe特有的扩展功能，如电源管理、高级错误报告（Advanced Error Reporting, AER）等。BIOS或UEFI会读取并初始化这些扩展配置寄存器。
    - 特殊的配置寄存器，如扩展配置空间中与虚拟化相关的功能（如SR-IOV）也在此阶段初始化。

5. **资源分配和设备使能**:
    - 与PCI类似，BIOS为PCIe设备分配内存地址空间，并将分配的资源写入BAR寄存器。
    - 配置空间中的命令寄存器被设置，启用设备的内存空间访问和中断处理。
    - PCIe设备的状态寄存器被初始化，确保设备准备就绪。

6. **设备状态和错误检查**:
    - 在完成资源分配和设备启用后，BIOS或UEFI会检查设备的状态寄存器，确保没有配置错误或冲突。
    - 如果系统支持PCIe高级错误报告（AER），相关寄存器会被初始化，以便监控和报告设备运行中的错误。

### **总结**

- **PCI**设备的配置寄存器初始化主要通过BIOS对设备配置空间的扫描和资源分配来实现。BIOS负责读取设备的标识信息、分析资源需求、分配系统资源，并启用设备的功能。
- **PCIe**设备的配置寄存器初始化过程更加复杂，不仅包括基本的资源分配和设备使能，还涉及链路初始化和高级功能的配置。PCIe设备通过扩展配置空间支持更多高级功能，如电源管理、错误报告等。BIOS或UEFI在启动过程中完成这些初始化工作，并为操作系统提供已配置的设备列表。