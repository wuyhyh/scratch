在对称多处理（SMP）系统中，每个CPU都有自己的运行队列，这种设计有助于提高系统的并行处理能力和调度效率。下面是该机制的实现细节：

### 每个CPU的运行队列

1. **运行队列结构**：
    - 每个CPU都有一个独立的运行队列，称为`runqueue`。这个队列包含了当前被分配到该CPU上的所有进程。
    - `runqueue`的数据结构通常包含以下内容：
        - 活动进程列表
        - 过期进程列表
        - 与调度相关的统计信息
        - 锁，用于保护`runqueue`的并发访问

2. **运行队列锁**：
    - 由于多个进程可能同时访问同一个运行队列，内核使用自旋锁（spinlock）来保护`runqueue`。这样可以确保对队列的操作是线程安全的。

3. **进程调度**：
    - 每个CPU的调度器负责从其对应的`runqueue`中选择下一个要运行的进程。
    - 调度器通过检查进程的优先级、虚拟运行时间（在CFS中）等指标来决定哪个进程应该获得CPU时间。

### 负载均衡（Load Balancing）

为了防止某些CPU过载而其他CPU闲置，SMP系统中实现了负载均衡机制：

1. **定期负载均衡**：
    - 内核会定期检查各个CPU的负载情况。如果发现某个CPU的负载明显高于其他CPU，调度器会尝试将一些进程迁移到负载较轻的CPU上。
    - 这种定期检查通常由调度器中的负载均衡器（load balancer）来完成。

2. **活动迁移**：
    - 当一个CPU上的运行队列过载时，负载均衡器会选择一些可迁移的进程，并将它们放到其他CPU的运行队列中。
    - 这种迁移需要考虑进程的亲和性、优先级和缓存局部性等因素，以尽量减少性能损失。

3. **多级负载均衡**：
    - 内核会在多个层次上进行负载均衡，比如在CPU核心之间、CPU集群之间，甚至在NUMA节点之间。
    - 通过多级负载均衡，内核可以更精细地管理系统资源，提升整体性能。

### 完全公平调度器（CFS）的实现

在CFS中，运行队列的管理和负载均衡机制进一步优化：

1. **红黑树**：
    - 每个CPU的`runqueue`中使用红黑树来管理进程。红黑树按虚拟运行时间（vruntime）排序，确保调度器总是选择vruntime最小的进程运行。
    - 这样可以保证调度的公平性，每个进程都能按其权重公平地获得CPU时间。

2. **CFS运行队列**：
    - 每个CPU都有一个CFS运行队列，包含当前处于可运行状态的所有进程。
    - 调度器通过遍历红黑树，选择下一个要运行的进程，并动态调整进程的vruntime，以实现完全公平调度。

3. **负载均衡器的作用**：
    - CFS的负载均衡器定期检查各个CPU的CFS运行队列，并在必要时执行负载均衡操作。
    - 负载均衡器通过迁移进程，确保各个CPU的负载大致均衡，避免单个CPU过载的情况。

### 总结

在SMP系统中，每个CPU都有自己的运行队列，通过自旋锁保护其并发访问。调度器负责从运行队列中选择进程运行，并通过负载均衡机制在各个CPU之间迁移进程，确保系统资源的有效利用。CFS通过红黑树和vruntime等机制，进一步优化了调度的公平性和效率。