# chapter 7 链接

链接把各种代码和数据片段收集在一起，然后组合成一个单一文件。
这个单一文件可以被加载到内存中执行。

链接可以发生在编译时、加载时、运行时。

链接器使大型软件的分离式编译成为可能。

链接的知识可以解决一些问题：

    大型程序是如何构造的
    避免一些危险的编程错误：比如全局变量的不恰当定义导致的隐藏错误
    理解语言作用域规则的本质
    帮助理解一些重要的系统概念：加载和运行程序、虚拟内存、分页、内存映射
    共享库和动态链接增加了链接的复杂性

对链接的讨论有以下几点：
    
    传统的静态链接
    加载时的动态链接
    运行时共享库的动态链接

## 7.1 编译器驱动程序

`compiler driver`会调用`cpp(C语言预处理器)`、`cc1(C编译器)`、`as(汇编器器)`生成`目标文件`。

`ld(链接器)`将编译器生成的目标文件和一些必要的`系统目标文件`组合起来，创建一个`可执行文件`。

在`shell`中输出程序的名称，`loader(加载器)`会将可执行文件的代码和数据复制到`内存`，然后将`控制`转移到程序的开头。

## 7.2 静态链接

静态连接器：`static linker`

输入是可重定位目标文件和命令行参数；输出是可以加载和运行的可执行目标文件。

可重定位的目标文件是由多个代码和数据的`section(节)`组成的。
每一节都是一个连续的`字节序列`。

链接器必须完成2个任务：

    符号解析
    重定位

符号对应一个函数、全局变量、静态变量。
符号解析的目的是将对一个符号的引用和符号的定义关联起来。

重定位：

编译器和链接器生成从地址0开始的代码节和数据节。
链接器把每个符号的定义和一个内存位置关联起来，并修改对这些符号的引用，让他们指向对应的内存位置。

一些重要的事实：
目标文件纯粹是字节块的集合。

这些块包含程序代码、程序数据、或者是引导链接器和加载器的数据结构。

链接器将这些块连接起来、确定运行时的位置，并且修改块中的各种位置。

链接器对机器的了解很少，大部分工作是编译器和汇编器完成的。

## 7.3 目标文件

目标文件有3种形式：
    
    可重定位目标文件：可以在编译时与其他可重定位目标文件合并成可执行目标文件
    可执行目标文件：可以被直接复制进内存并执行
    共享目标文件：可以在加载或运行时被动态地加载进内存并链接

一个目标文件就是一个字节序列。
目标文件在不同的系统上有不同的格式：unix和linux中是ELF格式。

## 7.4 可重定位目标文件

典型的ELF可重定位文件的格式：

    ELF header
    section 1 //entry
    section 2
    ...
    section header table

- ELF header描述了系统的字的长度和大小端以及帮助链接器工作的信息。
- 中间的section有多种，每一节都是一个固定大小的entry。
- section header table描述不同节的位置和大小。

典型的ELF文件的格式有很多节，有的节需要编译的时候指定选项才有。

```
.text节存放编译出的机器码
.rodata存放只读数据，比如打印语句的格式控制字符串、switch语句中的跳转表
.data存放已初始化的全局变量和静态C变量。
局部C变量在运行时被保存在栈中
.bss存放未初始化的全局变量和静态C变量，初始化值为0的全局变量和静态变量也放在这里，等效。

在目标文件中区分已初始化变量和未初始化变量是为了空间效率。
在目标文件中，未初始化变量不占据任何实际的磁盘空间。
运行时，在内存中分配这些变量，值为0

.symtab符号表存放程序中定义和引用的函数和全局变量的信息。不包含局部变量的条目。
.rel.text:记录.text节中位置的列表，链接器组合多个目标文件的时候会修改这些位置。
调用本地函数的指令不需要修改。
注意：可执行的目标文件里面不包括重定位信息。
.rel.data:被模块引用和定义的全局变量的重定位信息。任何已被初始化的全局变量，如果他的值是地址，都需要被修改。
.debug:一个调试符号表，包含了源程序代码和函数局部变量等信息。 -g
.line:C源程序行号和.text节机器指令之间的映射. -g
.strtab:字符串表，比如".text"这个表示节名字的字符串就放在这里。

```

## 7.5 符号和符号表

一个C语言源文件就是一个模块。

在链接器的上下文中，有3种符号：

- 本文件定义的全局符号，本文件和其他文件都可以使用
```C
int global;
```
- 其他文件定义的全局符号，在本文件中使用
```C
extern int global;
```
- 只在本文件中定义和使用的符号
```C
static int x;
static int func();
```

这三种链接器看到的符号和函数内部的符号不一样，函数内部的符号是在运行时的栈中管理的。
.symtab中的符号表不包含这些符号。

函数内部带有static的局部变量不在栈中管理，编译器为他们在.data和.bss中分配空间。
在符号表.symtab中会包含这些符号，如果在不同的函数中声明相同名称的static符号还会被赋予不同的链接器符号。

C语言的特性：

    在C语言中，源文件扮演了模块的角色。
    任何带有static的全局变量和函数都是模块私有的。
    任何不带有state的全局变量和函数都是公共的，可以被其他模块访问。


















